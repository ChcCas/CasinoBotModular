# modules/handlers/start.py

from pathlib import Path
from telegram import Update
from telegram.error import BadRequest
from telegram.ext import CommandHandler, ContextTypes, Application
from modules.config import ADMIN_ID
from modules.keyboards import main_menu, admin_panel_kb
from modules.states import STEP_MENU

PROJECT_ROOT = Path(__file__).resolve().parents[2]
ASSETS_DIR   = PROJECT_ROOT / "assets"
GIF_PATH     = ASSETS_DIR / "welcome.gif"

async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """
    ĞĞ±Ñ€Ğ¾Ğ±ĞºĞ° /start Ğ°Ğ±Ğ¾ Ğ½Ğ°Ñ‚Ğ¸ÑĞºĞ°Ğ½Ğ½Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ â€œĞ“Ğ¾Ğ»Ğ¾Ğ²Ğ½Ğµ Ğ¼ĞµĞ½Ñâ€/â€œĞĞ°Ğ·Ğ°Ğ´â€.
    ĞĞ°Ğ´ÑĞ¸Ğ»Ğ°Ñ”Ñ‚ÑŒÑÑ Ğ°Ğ±Ğ¾ Ñ€ĞµĞ´Ğ°Ğ³ÑƒÑ”Ñ‚ÑŒÑÑ Ñ”Ğ´Ğ¸Ğ½Ğµ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ Ğ· Ğ³Ğ¾Ğ»Ğ¾Ğ²Ğ½Ğ¸Ğ¼ Ğ¼ĞµĞ½Ñ.
    """
    if update.callback_query:
        await update.callback_query.answer()

    chat_id = update.effective_chat.id
    user_id = update.effective_user.id

    # Ğ’Ğ¸Ğ·Ğ½Ğ°Ñ‡Ğ°Ñ”Ğ¼Ğ¾ Ñ‚ĞµĞºÑÑ‚ Ñ– ĞºĞ»Ğ°Ğ²Ñ–Ğ°Ñ‚ÑƒÑ€Ñƒ
    if user_id == ADMIN_ID:
        text = "ğŸ›  ĞĞ´Ğ¼Ñ–Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ"
        keyboard = admin_panel_kb()
    else:
        text = "ğŸ² Ğ›Ğ°ÑĞºĞ°Ğ²Ğ¾ Ğ¿Ñ€Ğ¾ÑĞ¸Ğ¼Ğ¾ Ğ´Ğ¾ BIG GAME MONEY!"
        keyboard = main_menu(is_admin=False)

    base_id = context.user_data.get("base_msg_id")
    if base_id:
        # ÑĞ¿Ñ€Ğ¾Ğ±ÑƒÑ”Ğ¼Ğ¾ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸ Ñ–ÑĞ½ÑƒÑÑ‡Ğµ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ
        try:
            await context.bot.edit_message_text(
                chat_id=chat_id,
                message_id=base_id,
                text=text,
                reply_markup=keyboard
            )
        except BadRequest as e:
            # Ğ†Ğ³Ğ½Ğ¾Ñ€ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºÑƒ, ÑĞºÑ‰Ğ¾ Ñ‚ĞµĞºÑÑ‚ Ñ– ĞºĞ»Ğ°Ğ²Ñ–Ğ°Ñ‚ÑƒÑ€Ğ° Ğ½Ğµ Ğ·Ğ¼Ñ–Ğ½Ğ¸Ğ»Ğ¸ÑÑ
            if "Message is not modified" not in str(e):
                raise
    else:
        sent = await update.effective_chat.send_message(
            text=text,
            reply_markup=keyboard
        )
        context.user_data["base_msg_id"] = sent.message_id

    return STEP_MENU

def register_start_handler(app: Application) -> None:
    app.add_handler(CommandHandler("start", start_command), group=0)

from telegram import InlineKeyboardButton, InlineKeyboardMarkup, Update, Message
from telegram.ext import (
    CommandHandler, CallbackQueryHandler, ConversationHandler,
    MessageHandler, filters, ContextTypes
)
import re
import sqlite3
from modules.config import ADMIN_ID, DB_NAME

# === –°—Ç–∞–Ω ===
(
    STEP_MENU,
    STEP_CLIENT_CARD,
    STEP_PROVIDER,
    STEP_PAYMENT,
    STEP_CONFIRM_FILE,
    STEP_CONFIRMATION,
) = range(6)

PROVIDERS = ["üèÜ CHAMPION", "üé∞ SUPEROMATIC"]
PAYMENTS = ["–ö–∞—Ä—Ç–∞", "–ö—Ä–∏–ø—Ç–æ–ø–µ—Ä–µ–∫–∞–∑"]

def setup_handlers(application):
    conv = ConversationHandler(
        entry_points=[CommandHandler("start", start)],
        states={
            STEP_MENU: [CallbackQueryHandler(menu_handler)],
            STEP_CLIENT_CARD: [MessageHandler(filters.TEXT & ~filters.COMMAND, process_card)],
            STEP_PROVIDER: [CallbackQueryHandler(process_provider)],
            STEP_PAYMENT: [CallbackQueryHandler(process_payment)],
            STEP_CONFIRM_FILE: [MessageHandler(filters.Document.ALL | filters.PHOTO | filters.VIDEO, process_file)],
            STEP_CONFIRMATION: [CallbackQueryHandler(confirm_submission)],
        },
        fallbacks=[CommandHandler("start", start)]
    )
    application.add_handler(conv)

def nav_buttons():
    return InlineKeyboardMarkup([
        [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="back")],
        [InlineKeyboardButton("üè† –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é", callback_data="home")]
    ])

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("üé≤ –Ø –ö–ª—ñ—î–Ω—Ç", callback_data="client")],
        [InlineKeyboardButton("üìù –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è", callback_data="register")],
        [InlineKeyboardButton("üí∞ –ü–æ–ø–æ–≤–Ω–∏—Ç–∏", callback_data="deposit")],
        [InlineKeyboardButton("üí∏ –í–∏–≤—ñ–¥ –∫–æ—à—Ç—ñ–≤", callback_data="withdraw")],
        [InlineKeyboardButton("‚ÑπÔ∏è –î–æ–ø–æ–º–æ–≥–∞", callback_data="help")]
    ]
    user = update.effective_user
    if user.id == ADMIN_ID:
        keyboard.append([InlineKeyboardButton("üõ† –ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å", callback_data="admin_panel")])
    text = "–í—ñ—Ç–∞—î–º–æ —É Casino Club Telegram Bot! –û–±–µ—Ä—ñ—Ç—å –¥—ñ—é:"
    if update.message:
        await update.message.reply_text(text, reply_markup=InlineKeyboardMarkup(keyboard))
    elif update.callback_query:
        await update.callback_query.message.edit_text(text, reply_markup=InlineKeyboardMarkup(keyboard))
    return STEP_MENU

async def menu_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    if query.data == "admin_panel":
        keyboard = [
            [InlineKeyboardButton("üí∞ –£—Å—ñ –ø–æ–ø–æ–≤–Ω–µ–Ω–Ω—è", callback_data="admin_deposits")],
            [InlineKeyboardButton("üë§ –ó–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ", callback_data="admin_users")],
            [InlineKeyboardButton("üìÑ –ó–∞—è–≤–∫–∏ –Ω–∞ –≤–∏–≤–µ–¥–µ–Ω–Ω—è", callback_data="admin_withdrawals")],
            [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="admin_stats")],
            [InlineKeyboardButton("üè† –ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é", callback_data="home")]
        ]
        await query.message.reply_text("–ü–∞–Ω–µ–ª—å –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞:", reply_markup=InlineKeyboardMarkup(keyboard))
        return STEP_MENU

    if query.data == "admin_deposits":
        with sqlite3.connect(DB_NAME) as conn:
            cur = conn.cursor()
            cur.execute("SELECT username, card, provider, payment, timestamp FROM deposits ORDER BY timestamp DESC LIMIT 10")
            rows = cur.fetchall()
        if not rows:
            await query.message.reply_text("–ó–∞–ø–∏—Å—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.")
        else:
            text = "\n\n".join([f"üë§ {r[0] or '‚Äî'}\n–ö–∞—Ä—Ç–∫–∞: {r[1]}\n–ü—Ä–æ–≤–∞–π–¥–µ—Ä: {r[2]}\n–û–ø–ª–∞—Ç–∞: {r[3]}\nüïí {r[4]}" for r in rows])
            await query.message.reply_text(f"–û—Å—Ç–∞–Ω–Ω—ñ –ø–æ–ø–æ–≤–Ω–µ–Ω–Ω—è:\n\n{text}")
        return STEP_MENU

    if query.data == "admin_users":
        with sqlite3.connect(DB_NAME) as conn:
            cur = conn.cursor()
            cur.execute("SELECT name, phone, status FROM registrations ORDER BY id DESC LIMIT 10")
            rows = cur.fetchall()
        if not rows:
            await query.message.reply_text("–ù–µ–º–∞—î –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤.")
        else:
            text = "\n\n".join([f"üë§ –Ü–º‚Äô—è: {r[0]}\nüìû –¢–µ–ª–µ—Ñ–æ–Ω: {r[1]}\n–°—Ç–∞—Ç—É—Å: {r[2]}" for r in rows])
            await query.message.reply_text(f"–û—Å—Ç–∞–Ω–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ:\n\n{text}")
        return STEP_MENU

    if query.data == "admin_withdrawals":
        with sqlite3.connect(DB_NAME) as conn:
            cur = conn.cursor()
            cur.execute("""CREATE TABLE IF NOT EXISTS withdrawals (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                user_id INTEGER,
                username TEXT,
                amount TEXT,
                method TEXT,
                details TEXT,
                source_code TEXT,
                timestamp DATETIME DEFAULT CURRENT_TIMESTAMP
            )""")
            cur.execute("SELECT username, amount, method, details, source_code, timestamp FROM withdrawals ORDER BY id DESC LIMIT 10")
            rows = cur.fetchall()
        if not rows:
            await query.message.reply_text("–ó–∞—è–≤–æ–∫ –Ω–∞ –≤–∏–≤–µ–¥–µ–Ω–Ω—è –Ω–µ–º–∞—î.")
        else:
            text = "\n\n".join([f"üë§ {r[0] or '‚Äî'}\nüí∏ –°—É–º–∞: {r[1]}\nüí≥ –ú–µ—Ç–æ–¥: {r[2]}\nüì• –†–µ–∫–≤—ñ–∑–∏—Ç–∏: {r[3]}\nüî¢ –ö–æ–¥: {r[4]}\nüïí {r[5]}" for r in rows])
            await query.message.reply_text(f"–û—Å—Ç–∞–Ω–Ω—ñ –∑–∞—è–≤–∫–∏ –Ω–∞ –≤–∏–≤–µ–¥–µ–Ω–Ω—è:\n\n{text}")
        return STEP_MENU

    if query.data == "admin_stats":
        with sqlite3.connect(DB_NAME) as conn:
            cur = conn.cursor()
            cur.execute("SELECT COUNT(*) FROM registrations")
            users = cur.fetchone()[0]
            cur.execute("SELECT COUNT(*) FROM deposits")
            deposits = cur.fetchone()[0]
            cur.execute("SELECT COUNT(*) FROM withdrawals")
            withdrawals = cur.fetchone()[0]
        text = f"üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\nüë§ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤: {users}\nüí∞ –ü–æ–ø–æ–≤–Ω–µ–Ω—å: {deposits}\nüìÑ –í–∏–≤–µ–¥–µ–Ω—å: {withdrawals}"
        await query.message.reply_text(text)
        return STEP_MENU

    if query.data == "client":
        await query.message.reply_text("–í–≤–µ–¥—ñ—Ç—å –Ω–æ–º–µ—Ä –∫–∞—Ä—Ç–∫–∏ –∫–ª—ñ—î–Ω—Ç–∞ –∫–ª—É–±—É:", reply_markup=nav_buttons())
        return STEP_CLIENT_CARD

    if query.data in ("back", "home"):
        return await start(update, context)

    await query.message.reply_text("–¶—è —Ñ—É–Ω–∫—Ü—ñ—è —â–µ –≤ —Ä–æ–∑—Ä–æ–±—Ü—ñ.", reply_markup=nav_buttons())
    return STEP_MENU
